<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker镜像代理管理</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #409EFF;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .tabs-content {
            margin-top: 20px;
        }
        .form-container {
            max-width: 500px;
        }
        .status-enabled {
            color: #67c23a;
        }
        .status-disabled {
            color: #f56c6c;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 头部 -->
            <div class="header">
                <h1>Docker镜像代理管理系统</h1>
                <p>管理镜像源、白名单和用户</p>
            </div>

            <!-- 登录表单 -->
            <el-dialog title="管理员登录" :visible.sync="showLogin" :close-on-click-modal="false">
                <el-form :model="loginForm" label-width="80px">
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" placeholder="请输入用户名"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" placeholder="请输入密码"></el-input>
                    </el-form-item>
                </el-form>
                <div slot="footer">
                    <el-button @click="showLogin = false">取消</el-button>
                    <el-button type="primary" @click="login">登录</el-button>
                </div>
            </el-dialog>

            <!-- 主内容 -->
            <div v-if="isLoggedIn">
                <el-tabs v-model="activeTab" @tab-click="handleTabClick">
                    <!-- 镜像源管理 -->
                    <el-tab-pane label="镜像源管理" name="registries">
                        <div class="tabs-content">
                            <el-button type="primary" @click="showRegistryForm = true">添加镜像源</el-button>
                            
                            <el-table :data="registries" style="width: 100%; margin-top: 20px;">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="url" label="镜像源URL"></el-table-column>
                                <el-table-column prop="priority" label="优先级" width="100"></el-table-column>
                                <el-table-column prop="enabled" label="状态" width="100">
                                    <template slot-scope="scope">
                                        <span :class="scope.row.enabled ? 'status-enabled' : 'status-disabled'">
                                            {{ scope.row.enabled ? '启用' : '禁用' }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200">
                                    <template slot-scope="scope">
                                        <el-button size="mini" @click="editRegistry(scope.row)">编辑</el-button>
                                        <el-button size="mini" type="danger" @click="deleteRegistry(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 添加/编辑镜像源对话框 -->
                            <el-dialog :title="registryFormTitle" :visible.sync="showRegistryForm">
                                <el-form :model="registryForm" label-width="100px" class="form-container">
                                    <el-form-item label="URL">
                                        <el-input v-model="registryForm.url" placeholder="请输入镜像源URL"></el-input>
                                    </el-form-item>
                                    <el-form-item label="优先级">
                                        <el-input-number v-model="registryForm.priority" :min="1" :max="100"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="状态">
                                        <el-switch v-model="registryForm.enabled"></el-switch>
                                    </el-form-item>
                                </el-form>
                                <div slot="footer">
                                    <el-button @click="showRegistryForm = false">取消</el-button>
                                    <el-button type="primary" @click="saveRegistry">保存</el-button>
                                </div>
                            </el-dialog>
                        </div>
                    </el-tab-pane>

                    <!-- 白名单管理 -->
                    <el-tab-pane label="白名单管理" name="whitelists">
                        <div class="tabs-content">
                            <el-button type="primary" @click="showWhitelistForm = true">添加白名单</el-button>
                            
                            <el-table :data="whitelists" style="width: 100%; margin-top: 20px;">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="prefix" label="镜像前缀"></el-table-column>
                                <el-table-column prop="enabled" label="状态" width="100">
                                    <template slot-scope="scope">
                                        <span :class="scope.row.enabled ? 'status-enabled' : 'status-disabled'">
                                            {{ scope.row.enabled ? '启用' : '禁用' }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="150">
                                    <template slot-scope="scope">
                                        <el-button size="mini" type="danger" @click="deleteWhitelist(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 添加白名单对话框 -->
                            <el-dialog title="添加白名单" :visible.sync="showWhitelistForm">
                                <el-form :model="whitelistForm" label-width="100px" class="form-container">
                                    <el-form-item label="镜像前缀">
                                        <el-input v-model="whitelistForm.prefix" placeholder="例如: helloz"></el-input>
                                    </el-form-item>
                                    <el-form-item label="状态">
                                        <el-switch v-model="whitelistForm.enabled"></el-switch>
                                    </el-form-item>
                                </el-form>
                                <div slot="footer">
                                    <el-button @click="showWhitelistForm = false">取消</el-button>
                                    <el-button type="primary" @click="saveWhitelist">保存</el-button>
                                </div>
                            </el-dialog>
                        </div>
                    </el-tab-pane>

                    <!-- 用户管理 -->
                    <el-tab-pane label="用户管理" name="users">
                        <div class="tabs-content">
                            <el-button type="primary" @click="showUserForm = true">添加用户</el-button>
                            
                            <el-table :data="users" style="width: 100%; margin-top: 20px;">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="username" label="用户名"></el-table-column>
                                <el-table-column prop="created_at" label="创建时间">
                                    <template slot-scope="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="150">
                                    <template slot-scope="scope">
                                        <el-button size="mini" type="danger" @click="deleteUser(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!-- 添加用户对话框 -->
                            <el-dialog title="添加用户" :visible.sync="showUserForm">
                                <el-form :model="userForm" label-width="100px" class="form-container">
                                    <el-form-item label="用户名">
                                        <el-input v-model="userForm.username" placeholder="请输入用户名"></el-input>
                                    </el-form-item>
                                    <el-form-item label="密码">
                                        <el-input v-model="userForm.password" type="password" placeholder="请输入密码"></el-input>
                                    </el-form-item>
                                </el-form>
                                <div slot="footer">
                                    <el-button @click="showUserForm = false">取消</el-button>
                                    <el-button type="primary" @click="saveUser">保存</el-button>
                                </div>
                            </el-dialog>
                        </div>
                    </el-tab-pane>

                    <!-- 访问日志 -->
                    <el-tab-pane label="访问日志" name="logs">
                        <div class="tabs-content">
                            <el-button @click="loadLogs">刷新日志</el-button>
                            
                            <el-table :data="logs" style="width: 100%; margin-top: 20px;" max-height="600">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="client_ip" label="客户端IP" width="120"></el-table-column>
                                <el-table-column prop="method" label="方法" width="80"></el-table-column>
                                <el-table-column prop="path" label="路径" min-width="200"></el-table-column>
                                <el-table-column prop="status_code" label="状态码" width="100"></el-table-column>
                                <el-table-column prop="username" label="用户" width="120"></el-table-column>
                                <el-table-column prop="created_at" label="时间" width="180">
                                    <template slot-scope="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    // 登录状态
                    isLoggedIn: false,
                    showLogin: true,
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    
                    // 当前选项卡
                    activeTab: 'registries',
                    
                    // 镜像源管理
                    registries: [],
                    showRegistryForm: false,
                    registryForm: {
                        id: null,
                        url: '',
                        priority: 1,
                        enabled: true
                    },
                    
                    // 白名单管理
                    whitelists: [],
                    showWhitelistForm: false,
                    whitelistForm: {
                        prefix: '',
                        enabled: true
                    },
                    
                    // 用户管理
                    users: [],
                    showUserForm: false,
                    userForm: {
                        username: '',
                        password: ''
                    },
                    
                    // 访问日志
                    logs: []
                }
            },
            computed: {
                registryFormTitle() {
                    return this.registryForm.id ? '编辑镜像源' : '添加镜像源';
                }
            },
            mounted() {
                // 检查是否已登录
                const token = localStorage.getItem('auth_token');
                if (token) {
                    axios.defaults.headers.common['Authorization'] = token;
                    this.isLoggedIn = true;
                    this.showLogin = false;
                    this.loadRegistries();
                }
            },
            methods: {
                // 登录
                login() {
                    if (!this.loginForm.username || !this.loginForm.password) {
                        this.$message.error('请填写用户名和密码');
                        return;
                    }
                    
                    const token = 'Basic ' + btoa(this.loginForm.username + ':' + this.loginForm.password);
                    axios.defaults.headers.common['Authorization'] = token;
                    
                    // 测试登录
                    axios.get('/api/registries').then(() => {
                        localStorage.setItem('auth_token', token);
                        this.isLoggedIn = true;
                        this.showLogin = false;
                        this.loadRegistries();
                        this.$message.success('登录成功');
                    }).catch(() => {
                        this.$message.error('登录失败，请检查用户名和密码');
                        delete axios.defaults.headers.common['Authorization'];
                    });
                },
                
                // 标签页切换
                handleTabClick(tab) {
                    switch(tab.name) {
                        case 'registries':
                            this.loadRegistries();
                            break;
                        case 'whitelists':
                            this.loadWhitelists();
                            break;
                        case 'users':
                            this.loadUsers();
                            break;
                        case 'logs':
                            this.loadLogs();
                            break;
                    }
                },
                
                // 镜像源管理
                loadRegistries() {
                    axios.get('/api/registries').then(response => {
                        this.registries = response.data;
                    }).catch(error => {
                        this.$message.error('加载镜像源失败');
                    });
                },
                
                editRegistry(registry) {
                    this.registryForm = { ...registry };
                    this.showRegistryForm = true;
                },
                
                saveRegistry() {
                    if (!this.registryForm.url) {
                        this.$message.error('请填写镜像源URL');
                        return;
                    }
                    
                    const isEdit = this.registryForm.id;
                    const method = isEdit ? 'put' : 'post';
                    
                    axios[method]('/api/registries', this.registryForm).then(() => {
                        this.$message.success(isEdit ? '更新成功' : '添加成功');
                        this.showRegistryForm = false;
                        this.resetRegistryForm();
                        this.loadRegistries();
                    }).catch(() => {
                        this.$message.error('保存失败');
                    });
                },
                
                deleteRegistry(id) {
                    this.$confirm('确认删除此镜像源？', '提示').then(() => {
                        axios.delete(`/api/registries/${id}`).then(() => {
                            this.$message.success('删除成功');
                            this.loadRegistries();
                        }).catch(() => {
                            this.$message.error('删除失败');
                        });
                    });
                },
                
                resetRegistryForm() {
                    this.registryForm = {
                        id: null,
                        url: '',
                        priority: 1,
                        enabled: true
                    };
                },
                
                // 白名单管理
                loadWhitelists() {
                    axios.get('/api/whitelists').then(response => {
                        this.whitelists = response.data;
                    }).catch(() => {
                        this.$message.error('加载白名单失败');
                    });
                },
                
                saveWhitelist() {
                    if (!this.whitelistForm.prefix) {
                        this.$message.error('请填写镜像前缀');
                        return;
                    }
                    
                    axios.post('/api/whitelists', this.whitelistForm).then(() => {
                        this.$message.success('添加成功');
                        this.showWhitelistForm = false;
                        this.resetWhitelistForm();
                        this.loadWhitelists();
                    }).catch(() => {
                        this.$message.error('添加失败');
                    });
                },
                
                deleteWhitelist(id) {
                    this.$confirm('确认删除此白名单？', '提示').then(() => {
                        axios.delete(`/api/whitelists/${id}`).then(() => {
                            this.$message.success('删除成功');
                            this.loadWhitelists();
                        }).catch(() => {
                            this.$message.error('删除失败');
                        });
                    });
                },
                
                resetWhitelistForm() {
                    this.whitelistForm = {
                        prefix: '',
                        enabled: true
                    };
                },
                
                // 用户管理
                loadUsers() {
                    axios.get('/api/users').then(response => {
                        this.users = response.data;
                    }).catch(() => {
                        this.$message.error('加载用户失败');
                    });
                },
                
                saveUser() {
                    if (!this.userForm.username || !this.userForm.password) {
                        this.$message.error('请填写用户名和密码');
                        return;
                    }
                    
                    axios.post('/api/users', this.userForm).then(() => {
                        this.$message.success('添加成功');
                        this.showUserForm = false;
                        this.resetUserForm();
                        this.loadUsers();
                    }).catch(() => {
                        this.$message.error('添加失败');
                    });
                },
                
                deleteUser(id) {
                    this.$confirm('确认删除此用户？', '提示').then(() => {
                        axios.delete(`/api/users/${id}`).then(() => {
                            this.$message.success('删除成功');
                            this.loadUsers();
                        }).catch(() => {
                            this.$message.error('删除失败');
                        });
                    });
                },
                
                resetUserForm() {
                    this.userForm = {
                        username: '',
                        password: ''
                    };
                },
                
                // 访问日志
                loadLogs() {
                    axios.get('/api/logs?limit=100').then(response => {
                        this.logs = response.data;
                    }).catch(() => {
                        this.$message.error('加载日志失败');
                    });
                },
                
                // 工具方法
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            }
        });
    </script>
</body>
</html>
